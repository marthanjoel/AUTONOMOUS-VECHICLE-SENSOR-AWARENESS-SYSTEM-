// -------- PIN DEFINITIONS --------
int irPin = 2;          // IR obstacle sensor
int opticPin = 3;       // Optical break beam sensor
int flamePin = 7;       // Flame sensor

int clk = 4;            // Rotary encoder CLK
int dt  = 5;            // Rotary encoder DT
int sw  = 6;            // Rotary encoder button

int redLED = 9;         // Red LED (PWM)
int greenLED = 10;      // Green LED (PWM)
int blueLED = 11;       // Blue LED (PWM)

bool systemOn = false;      // System state
bool buttonPressed = false; // Encoder button debounce

int lastCLK;
int ledBrightness = 128;    // Initial LED brightness (0-255)

void setup() {
  // Sensors
  pinMode(irPin, INPUT);
  pinMode(opticPin, INPUT);
  pinMode(flamePin, INPUT);

  // Rotary encoder
  pinMode(clk, INPUT);
  pinMode(dt, INPUT);
  pinMode(sw, INPUT_PULLUP);

  // LEDs
  pinMode(redLED, OUTPUT);
  pinMode(greenLED, OUTPUT);
  pinMode(blueLED, OUTPUT);

  Serial.begin(9600);
  lastCLK = digitalRead(clk);
}

void loop() {
  // ---- BUTTON: Toggle System ON/OFF ----
  if (digitalRead(sw) == LOW) {
    if (!buttonPressed) {
      buttonPressed = true;
      systemOn = !systemOn;  // Toggle system
      Serial.println(systemOn ? "SYSTEM TURNED ON" : "SYSTEM TURNED OFF");
      delay(200); // simple debounce
    }
  } else buttonPressed = false;

  // ---- ROTARY: Adjust LED brightness ----
  int clkState = digitalRead(clk);
  int dtState = digitalRead(dt);

  // Detect only rising edge of CLK
  if (clkState != lastCLK && clkState == HIGH && systemOn) {
    if (dtState != clkState) {
      // Clockwise → increase brightness
      ledBrightness += 15;
      if (ledBrightness > 255) ledBrightness = 255;
    } else {
      // Counter-clockwise → decrease brightness
      ledBrightness -= 15;
      if (ledBrightness < 0) ledBrightness = 0;
    }
    Serial.print("LED Brightness: ");
    Serial.println(ledBrightness);
  }
  lastCLK = clkState;

  // ---- SYSTEM LOGIC ----
  if (systemOn) {
    int irState = digitalRead(irPin);      // LOW = obstacle
    int opticState = digitalRead(opticPin); // HIGH = beam blocked
    int flameState = digitalRead(flamePin); // LOW = flame detected

    // Reset all LEDs
    analogWrite(redLED, 0);
    analogWrite(greenLED, 0);
    analogWrite(blueLED, 0);

    // ---- FLAME DETECTION (HIGHEST PRIORITY) ----
    if (flameState == HIGH) {
      analogWrite(redLED, ledBrightness);
      analogWrite(greenLED, ledBrightness);
      analogWrite(blueLED, ledBrightness);  // RGB = WHITE
      Serial.println("ALERT: FIRE DETECTED!");
    delay(1000);
    }
    // ---- IR OBSTACLE ----
    else if (irState == LOW) {
      analogWrite(redLED, ledBrightness);
      Serial.println("IR SENSOR: OBSTACLE DETECTED");
    delay(1000);
    }
    // ---- OPTICAL BLOCKED ----
    else if (opticState == HIGH) {
      analogWrite(blueLED, ledBrightness);
      Serial.println("OPTICAL SENSOR: BEAM BLOCKED");
    delay(1000);
    }
    // ---- ALL CLEAR ----
    else {
      analogWrite(greenLED, ledBrightness);
      Serial.println("STATUS: ALL CLEAR");
    }
  }
  else {
    // Turn off all LEDs if system is OFF
    analogWrite(redLED, 0);
    analogWrite(greenLED, 0);
    analogWrite(blueLED, 0);
  }
}
